<!-- templates/browse_instruments.html -->
{% extends "base.html" %}

{% block content %}
<div class="bg-white rounded-lg shadow-md p-6">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold">{{ exchange_code.replace('_', ' ') }} Instruments</h1>
        <a href="{{ url_for('instruments') }}" class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded">
            Back to Exchanges
        </a>
    </div>

    <div class="mb-6">
        <div class="relative">
            <input type="text"
                   id="search-input"
                   name="search"
                   value="{{ search }}"
                   placeholder="Search by symbol or name (start typing...)"
                   class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            <div id="loading-indicator" class="absolute right-3 top-2.5 hidden">
                <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-blue-600"></div>
            </div>
        </div>
        <div id="search-status" class="mt-2 text-sm text-gray-500"></div>
    </div>

    <div id="instruments-container">
        {% if instruments.items %}
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead>
                <tr>
                    <th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Symbol
                    </th>
                    <th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Name
                    </th>
                    {% if 'FO' in exchange_code %}
                    <th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Expiry
                    </th>
                    <th class="px-4 py-3 bg-gray-50 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Strike
                    </th>
                    <th class="px-4 py-3 bg-gray-50 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Type
                    </th>
                    {% endif %}
                    <th class="px-4 py-3 bg-gray-50 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Lot Size
                    </th>
                    <th class="px-4 py-3 bg-gray-50 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Tick Size
                    </th>
                    <th class="px-4 py-3 bg-gray-50 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Actions
                    </th>
                </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                {% for instrument in instruments.items %}
                <tr>
                    <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ instrument.symbol }}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">{{ instrument.name }}</td>
                    {% if 'FO' in exchange_code %}
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">
                        {{ instrument.expiry_date.strftime('%d-%b-%Y') if instrument.expiry_date else '-' }}
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-right text-gray-500">
                        {{ instrument.strike_price if instrument.strike_price else '-' }}
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-center text-gray-500">
                        {{ instrument.option_type if instrument.option_type and instrument.option_type != 'XX' else '-' }}
                    </td>
                    {% endif %}
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-right text-gray-500">{{ instrument.lot_size }}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-right text-gray-500">{{ instrument.tick_size }}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-center">
                        <div class="flex space-x-2 justify-center">
                            <a href="{{ url_for('view_instrument', fy_token=instrument.fy_token) }}"
                               class="text-blue-600 hover:text-blue-800">View</a>
                            <span class="text-gray-300">|</span>
                            <a href="{{ url_for('market', fy_token=instrument.fy_token) }}"
                               class="text-green-600 hover:text-green-800">Market Data</a>
                        </div>
                    </td>
                </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        <div class="mt-6 flex items-center justify-between" id="pagination-container">
            <div>
                <p class="text-sm text-gray-700">
                    Showing <span class="font-medium">{{ instruments.items|length }}</span> of
                    <span class="font-medium">{{ instruments.total }}</span> instruments
                </p>
            </div>
            <div class="flex space-x-2">
                {% if instruments.has_prev %}
                <a href="{{ url_for('browse_instruments', exchange_code=exchange_code, page=instruments.prev_num, search=search) }}"
                   class="px-3 py-1 border border-gray-300 rounded text-sm hover:bg-gray-50">
                    Previous
                </a>
                {% else %}
                <span class="px-3 py-1 border border-gray-300 rounded text-sm text-gray-400 bg-gray-100">Previous</span>
                {% endif %}

                {% for page_num in instruments.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
                {% if page_num %}
                {% if page_num == instruments.page %}
                <span class="px-3 py-1 border border-blue-500 bg-blue-500 text-white rounded text-sm">{{ page_num }}</span>
                {% else %}
                <a href="{{ url_for('browse_instruments', exchange_code=exchange_code, page=page_num, search=search) }}"
                   class="px-3 py-1 border border-gray-300 rounded text-sm hover:bg-gray-50">
                    {{ page_num }}
                </a>
                {% endif %}
                {% else %}
                <span class="px-2 py-1 text-gray-500">...</span>
                {% endif %}
                {% endfor %}

                {% if instruments.has_next %}
                <a href="{{ url_for('browse_instruments', exchange_code=exchange_code, page=instruments.next_num, search=search) }}"
                   class="px-3 py-1 border border-gray-300 rounded text-sm hover:bg-gray-50">
                    Next
                </a>
                {% else %}
                <span class="px-3 py-1 border border-gray-300 rounded text-sm text-gray-400 bg-gray-100">Next</span>
                {% endif %}
            </div>
        </div>
        {% else %}
        <div class="py-10 text-center">
            <p class="text-gray-500">No instruments found{% if search %} matching "{{ search }}"{% endif %}.</p>
            {% if search %}
            <a href="{{ url_for('browse_instruments', exchange_code=exchange_code) }}"
               class="mt-4 inline-block text-blue-600 hover:underline">
                Clear search and show all
            </a>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('search-input');
    const loadingIndicator = document.getElementById('loading-indicator');
    const statusDiv = document.getElementById('search-status');
    const instrumentsContainer = document.getElementById('instruments-container');

    let searchTimeout;
    let currentRequest;

    // Auto-search as user types
    searchInput.addEventListener('input', function() {
        const query = searchInput.value.trim();

        // Clear previous timeout
        clearTimeout(searchTimeout);

        // Cancel previous request if still pending
        if (currentRequest) {
            currentRequest.abort();
        }

        if (query.length === 0) {
            // If search is empty, reload the page to show all instruments
            window.location.href = `{{ url_for('browse_instruments', exchange_code=exchange_code) }}`;
            return;
        }

        if (query.length < 2) {
            statusDiv.textContent = 'Type at least 2 characters to search...';
            return;
        }

        statusDiv.textContent = `Searching for "${query}"...`;
        loadingIndicator.classList.remove('hidden');

        // Debounce the search to avoid too many requests
        searchTimeout = setTimeout(() => {
            performSearch(query);
        }, 300); // Wait 300ms after user stops typing
    });

    // Also allow Enter key for immediate search
    searchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            clearTimeout(searchTimeout);
            const query = searchInput.value.trim();
            if (query.length >= 2) {
                performSearch(query);
            } else if (query.length === 0) {
                window.location.href = `{{ url_for('browse_instruments', exchange_code=exchange_code) }}`;
            }
        }
    });

    function performSearch(query) {
        // Create AbortController for this request
        const controller = new AbortController();
        currentRequest = controller;

        // Construct the URL for the search
        const searchUrl = `{{ url_for('browse_instruments', exchange_code=exchange_code) }}?search=${encodeURIComponent(query)}`;

        fetch(searchUrl, {
            signal: controller.signal,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.text();
        })
        .then(html => {
            loadingIndicator.classList.add('hidden');
            currentRequest = null;

            // Create a temporary div to parse the response HTML
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;

            // Extract the instruments container content from the response
            const newContent = tempDiv.querySelector('#instruments-container');
            if (newContent) {
                instrumentsContainer.innerHTML = newContent.innerHTML;
                statusDiv.textContent = `Search results for "${query}"`;

                // Update the URL without reloading the page
                const newUrl = new URL(window.location);
                newUrl.searchParams.set('search', query);
                window.history.pushState({search: query}, '', newUrl);
            } else {
                statusDiv.textContent = `No results found for "${query}"`;
                instrumentsContainer.innerHTML = `
                    <div class="py-10 text-center">
                        <p class="text-gray-500">No instruments found matching "${escapeHtml(query)}".</p>
                        <button onclick="clearSearch()" class="mt-4 inline-block text-blue-600 hover:underline">
                            Clear search and show all
                        </button>
                    </div>
                `;
            }
        })
        .catch(error => {
            currentRequest = null;
            loadingIndicator.classList.add('hidden');

            if (error.name === 'AbortError') {
                // Request was cancelled, ignore
                return;
            }

            console.error('Search error:', error);
            statusDiv.textContent = `Error searching for "${query}"`;
            instrumentsContainer.innerHTML = `
                <div class="text-center py-8 text-red-500">
                    <p>Error occurred while searching: ${escapeHtml(error.message)}</p>
                    <p class="text-sm mt-2">Please try again or contact support if the problem persists.</p>
                </div>
            `;
        });
    }

    // Helper function to escape HTML
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Clear search function
    window.clearSearch = function() {
        searchInput.value = '';
        statusDiv.textContent = '';
        window.location.href = `{{ url_for('browse_instruments', exchange_code=exchange_code) }}`;
    };

    // Handle browser back/forward buttons
    window.addEventListener('popstate', function(event) {
        if (event.state && event.state.search) {
            searchInput.value = event.state.search;
            performSearch(event.state.search);
        } else {
            window.location.reload();
        }
    });

    // Set initial status if there's a search query
    {% if search %}
    statusDiv.textContent = 'Search results for "{{ search }}"';
    {% endif %}
});
</script>

<style>
/* Loading animation */
@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

.animate-spin {
    animation: spin 1s linear infinite;
}

/* Smooth transitions */
.transition-colors {
    transition-property: color, background-color, border-color;
    transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
    transition-duration: 150ms;
}

/* Search input focus styling */
#search-input:focus {
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

/* Loading state styling */
.searching {
    opacity: 0.7;
    pointer-events: none;
}
</style>
{% endblock %}